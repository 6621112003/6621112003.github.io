<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πà‡∏≤‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô (Realtime)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #fff7ed; }
    .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .page-enter { opacity: 0; }
    .page-enter-active { opacity: 1; transition: opacity 0.3s ease-out; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .category-btn.active { background: linear-gradient(135deg, #f97316, #fbbf24); color: white; border: none; }
    .star-rating i.active { color: #fbbf24; } 
    .star-rating i.inactive { color: #e5e7eb; }
  </style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full overflow-auto">
   
   <div id="loadingScreen" class="fixed inset-0 bg-orange-500 flex flex-col items-center justify-center z-[100] transition-opacity duration-500">
    <div class="text-6xl mb-4 animate-bounce">üî•</div>
    <div class="text-white text-2xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô...</div>
    <div id="debugText" class="text-white/80 text-sm mt-2">Connecting to Firebase...</div>
   </div>

   <div id="mainContent" class="hidden opacity-0 transition-opacity duration-500">
    <nav class="glass-effect sticky top-0 z-40 shadow-sm border-b border-orange-100">
     <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
       <div class="flex items-center gap-2 cursor-pointer" onclick="showPage('home')">
        <span class="text-3xl">üçú</span>
        <h1 class="text-lg font-bold text-gray-800">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô</h1>
       </div>
       <div class="flex gap-2">
        <button onclick="showPage('home')" class="px-3 py-1.5 bg-orange-100 text-orange-600 rounded-lg text-sm font-bold hover:bg-orange-200 transition"><i class="fa-solid fa-store"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button> 
        <button id="adminBtn" onclick="showPage('login')" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-200 transition"><i class="fa-solid fa-lock"></i> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
       </div>
     </div>
    </nav>

    <div id="homePage" class="page">
     <div class="bg-gradient-to-r from-orange-500 to-yellow-400 py-10 px-4 text-center text-white rounded-b-[2rem] shadow-lg mb-6">
       <h2 class="text-3xl font-bold mb-2">‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏õ‡∏±‡∏á üèÜ</h2>
       <div class="max-w-lg mx-auto bg-white rounded-full p-2 flex shadow-lg mt-4">
         <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." class="flex-1 px-4 outline-none text-gray-700" oninput="filterRestaurants()"> 
         <button class="bg-orange-500 text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fa-solid fa-search"></i></button>
       </div>
     </div>

     <div class="max-w-7xl mx-auto px-4 pb-20">
      <div class="mb-6 flex gap-2 overflow-x-auto hide-scrollbar pb-2">
        <button onclick="setCategory('')" class="category-btn active px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button> 
        <button onclick="setCategory('‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß">üçú ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</button> 
        <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á">üç≥ ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á</button> 
        <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô">üç£ ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</button>
        <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô">üå∂Ô∏è ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</button>
        <button onclick="setCategory('‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
        <button onclick="setCategory('‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‚òï ‡∏Å‡∏≤‡πÅ‡∏ü</button>
        <button onclick="setCategory('‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå')" class="category-btn px-4 py-1.5 bg-white border rounded-full text-sm font-medium whitespace-nowrap" data-category="‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå">üçñ ‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå</button>
      </div>

      <div id="restaurantGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="emptyState" class="hidden text-center py-20 text-gray-400">
        <div class="text-5xl mb-2">üçΩÔ∏è</div>
        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
      </div>
     </div>
    </div>

    <div id="detailPage" class="page hidden">
     <div class="max-w-4xl mx-auto px-4 py-6">
       <button onclick="showPage('home')" class="mb-4 text-gray-600 hover:text-orange-500 flex items-center gap-2 font-bold"><i class="fa-solid fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
       <div id="restaurantDetailContent" class="bg-white rounded-2xl shadow-xl overflow-hidden min-h-[50vh]"></div>
     </div>
    </div>

    <div id="loginPage" class="page hidden">
     <div class="min-h-screen flex items-center justify-center px-4 -mt-20">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
       <div class="text-5xl mb-4">üîê</div>
       <h2 class="text-xl font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
       <div class="text-sm bg-gray-100 p-3 rounded-lg mb-4 text-left text-gray-600">
           <b>Users (Pass: 1234)</b><br>
           üëë owner (‡∏Ñ‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)<br>
           üõ†Ô∏è moderator (‡∏£‡πâ‡∏≤‡∏ô+‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)<br>
           üîç inspector (‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
       </div>
       <input type="text" id="loginUsername" class="w-full mb-3 px-4 py-2 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
       <input type="password" id="loginPassword" class="w-full mb-6 px-4 py-2 border rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
       <button onclick="handleLogin()" class="w-full py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
     </div>
    </div>

    <div id="adminPage" class="page hidden">
     <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="bg-white rounded-2xl shadow p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
       <div>
           <h2 class="text-xl font-bold">üõ†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
           <p class="text-sm text-gray-500">Login: <span id="adminNameDisplay" class="text-orange-500 font-bold"></span></p>
       </div>
       <div class="flex gap-2">
         <button onclick="showRestaurantForm()" id="btnAddRest" class="px-4 py-2 bg-green-500 text-white rounded-lg font-bold shadow hover:bg-green-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
         <button onclick="handleLogout()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg font-bold hover:bg-red-200">‡∏≠‡∏≠‡∏Å</button>
       </div>
      </div>

      <div class="flex gap-2 mb-6 border-b pb-2">
          <button id="tabRestBtn" onclick="switchAdminTab('restaurants')" class="px-4 py-2 font-bold text-orange-500 border-b-2 border-orange-500">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="tabReviewBtn" onclick="switchAdminTab('reviews')" class="px-4 py-2 font-bold text-gray-500">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
          <button id="tabUserBtn" onclick="switchAdminTab('users')" class="px-4 py-2 font-bold text-gray-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      </div>

      <div id="adminTabRestaurants" class="admin-tab-content"><div id="adminRestaurantList" class="space-y-4"></div></div>
      <div id="adminTabReviews" class="admin-tab-content hidden"><div id="adminReviewList" class="space-y-4"></div></div>
      <div id="adminTabUsers" class="admin-tab-content hidden"><div id="adminUserList" class="space-y-4"></div></div>
     </div>
    </div>

    <div id="restaurantModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
      <div class="p-6">
       <h3 id="restaurantFormTitle" class="text-xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
       <div class="space-y-3">
        <input type="text" id="formName" class="w-full px-4 py-2 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô *">
        <div class="grid grid-cols-2 gap-2">
          <select id="formCategory" class="w-full px-4 py-2 border rounded-lg"><option value="">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option><option value="‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß">‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</option><option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option><option value="‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option><option value="‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå">‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå</option></select>
          <select id="formZone" class="w-full px-4 py-2 border rounded-lg"><option value="">‡πÄ‡∏Ç‡∏ï</option><option value="‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô">‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô</option><option value="‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£">‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£</option><option value="‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</option><option value="‡∏™‡∏¢‡∏≤‡∏°">‡∏™‡∏¢‡∏≤‡∏°</option><option value="‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå">‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå</option><option value="‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß">‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß</option><option value="‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó">‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó</option></select>
        </div>
        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
            <label class="text-xs font-bold text-blue-800 block mb-1">üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Google Maps</label>
            <input type="url" id="formMapUrl" class="w-full px-3 py-1 border rounded text-sm" placeholder="https://maps.app.goo.gl/...">
        </div>
        <textarea id="formDescription" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
        <div class="grid grid-cols-2 gap-2"><input type="text" id="formAddress" class="w-full border rounded px-3 py-2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"><input type="tel" id="formPhone" class="w-full border rounded px-3 py-2" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£"></div>
        <div class="grid grid-cols-2 gap-2"><div><span class="text-xs">‡πÄ‡∏õ‡∏¥‡∏î</span><input type="time" id="formOpenTime" class="w-full border rounded px-2 py-1"></div><div><span class="text-xs">‡∏õ‡∏¥‡∏î</span><input type="time" id="formCloseTime" class="w-full border rounded px-2 py-1"></div></div>
        
        <div class="border-2 border-dashed p-4 text-center rounded-lg">
            <div id="coverPreview" class="hidden mb-2"><img id="coverPreviewImg" class="h-32 mx-auto rounded object-cover"></div>
            <button onclick="document.getElementById('coverImageInput').click()" class="text-orange-500 text-sm font-bold">üì∑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å</button>
            <input type="file" id="coverImageInput" accept="image/*" onchange="handleCoverUpload(event)" class="hidden">
        </div>
        
        <div class="border-2 border-dashed p-4 text-center rounded-lg mt-2">
            <div id="galleryPreviewGrid" class="grid grid-cols-4 gap-2 mb-2"></div>
            <button onclick="document.getElementById('galleryImageInput').click()" class="text-blue-500 text-sm font-bold">üñºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ</button>
            <input type="file" id="galleryImageInput" accept="image/*" multiple onchange="handleGalleryUpload(event)" class="hidden">
        </div>

        <div class="flex gap-2 pt-4 border-t">
            <button onclick="closeRestaurantForm()" class="flex-1 py-2 bg-gray-200 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="saveRestaurant()" id="saveRestaurantBtn" class="flex-1 py-2 bg-orange-500 text-white rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
       </div>
      </div>
     </div>
    </div>

    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[90]" onclick="closeImageViewer()"><img id="fullImage" class="max-h-[90vh] max-w-[90vw] object-contain"></div>
    
    <div id="cropModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80] p-4"><div class="bg-white rounded-lg w-full max-w-2xl p-4"><div class="h-[50vh] bg-gray-100 mb-4"><img id="cropImage" style="max-width: 100%;"></div><div class="flex gap-2"><button onclick="closeCropModal()" class="flex-1 py-2 bg-gray-200 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="confirmCrop()" class="flex-1 py-2 bg-orange-500 text-white rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div>

   </div>
  </div>

  <script>
    // --- FIREBASE CONFIG (‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHX9l4CYgX0BCFliagOnBCK1oFbu7sp9s",
      authDomain: "rattawut-food.firebaseapp.com",
      projectId: "rattawut-food",
      storageBucket: "rattawut-food.firebasestorage.app",
      messagingSenderId: "928937247925",
      appId: "1:928937247925:web:5d58ca32296f841a126afc",
      databaseURL: "https://rattawut-food-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize
    if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); } }
    const db = firebase.database();

    // --- VARIABLES ---
    let dbData = { restaurants:[], reviews:[], users:[] };
    let currentUser = null, editingItem = null;
    let categoryFilter = '', coverImg = '', galleryImgs = [], cropper = null;
    let currentReviewRating = 0;

    // --- STARTUP ---
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
    window.onload = function() {
        startRealtimeSync();
    };

    function startRealtimeSync() {
        document.getElementById('debugText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô...";
        
        // 1. ‡∏î‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏∏‡∏î)
        db.ref('restaurants').on('value', (s) => { 
            const val = s.val();
            dbData.restaurants = val ? Object.values(val) : [];
            console.log("Restaurants loaded:", dbData.restaurants.length);
            renderGrid(dbData.restaurants); // ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if(currentUser) renderAdminRestaurants();
            hideLoader(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
        });

        // 2. ‡∏î‡∏∂‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
        db.ref('reviews').on('value', (s) => { 
            dbData.reviews = s.val() ? Object.values(s.val()) : [];
            if(currentUser) renderAdminReviews();
        });
        
        // 3. ‡∏î‡∏∂‡∏á User (‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Default ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á)
        db.ref('users').on('value', (s) => { 
            dbData.users = s.val() ? Object.values(s.val()) : [];
            if(dbData.users.length === 0) {
                create('users', { username: 'owner', password: '1234', role: 'owner' });
                create('users', { username: 'moderator', password: '1234', role: 'moderator' });
                create('users', { username: 'inspector', password: '1234', role: 'inspector' });
            }
        });
        
        // Failsafe: ‡∏ñ‡πâ‡∏≤ 3 ‡∏ß‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡∏¢
        setTimeout(hideLoader, 3000);
    }

    function hideLoader() {
        const loader = document.getElementById('loadingScreen');
        if(loader.style.display === 'none') return;
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
            setTimeout(() => document.getElementById('mainContent').classList.remove('opacity-0'), 50);
            showPage('home');
        }, 500);
    }

    // --- CRUD HELPER ---
    function create(col, item) { const newRef = db.ref(col).push(); item.__backendId = newRef.key; return newRef.set(item); }
    function update(col, item) { return db.ref(col + '/' + item.__backendId).set(item); }
    function remove(col, id) { return db.ref(col + '/' + id).remove(); }

    // --- FRONTEND LOGIC ---
    function showPage(p) { document.querySelectorAll('.page').forEach(x => { x.classList.remove('page-enter-active'); x.classList.add('hidden'); }); const t = document.getElementById(p + 'Page'); t.classList.remove('hidden'); t.classList.add('page-enter-active'); window.scrollTo(0,0); }
    function setCategory(c) { categoryFilter = c; document.querySelectorAll('.category-btn').forEach(b => b.classList.toggle('active', b.dataset.category === c)); filterRestaurants(); }

    function filterRestaurants() {
        const s = document.getElementById('searchInput').value.toLowerCase();
        let list = dbData.restaurants.filter(r => (!s || r.name.toLowerCase().includes(s)) && (!categoryFilter || r.category === categoryFilter));
        renderGrid(list);
    }
    
    function renderGrid(list) {
        const g = document.getElementById('restaurantGrid'), e = document.getElementById('emptyState');
        if(!list || list.length===0) { g.innerHTML=''; e.classList.remove('hidden'); return; }
        e.classList.add('hidden');
        
        // Sort by Rating (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
        list.sort((a,b) => getRating(b.__backendId).avg - getRating(a.__backendId).avg);

        g.innerHTML = list.map(r => {
            const stats = getRating(r.__backendId);
            return `
            <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl overflow-hidden card-hover cursor-pointer border border-gray-100" onclick="viewDetail('${r.__backendId}')">
                <div class="h-48 bg-gray-100 relative overflow-hidden">
                     ${r.coverImage ? `<div class="w-full h-full bg-cover bg-center" style="background-image:url('${r.coverImage}')"></div>` : `<div class="flex items-center justify-center h-full text-4xl">üçú</div>`}
                     <div class="absolute top-2 left-2 bg-white/90 px-2 py-1 rounded-full text-xs font-bold text-orange-600">${r.category}</div>
                     <div class="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded text-xs font-bold text-yellow-300">‚≠ê ${stats.avg} (${stats.count})</div>
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-lg text-gray-800 mb-1">${r.name}</h3>
                    <div class="text-xs text-gray-500 mb-2 flex items-center gap-1">üìç ${r.zone}</div>
                    <p class="text-gray-500 text-sm line-clamp-2 h-10">${r.description || '-'}</p>
                </div>
            </div>`;
        }).join('');
    }
    
    function getRating(rId) { const revs = dbData.reviews.filter(r => r.restaurantId === rId); if(revs.length === 0) return { avg: 0, count: 0 }; return { avg: (revs.reduce((a, b) => a + b.rating, 0) / revs.length).toFixed(1), count: revs.length }; }

    function viewDetail(id) {
        const r = dbData.restaurants.find(i => i.__backendId === id); if(!r) return;
        const stats = getRating(id);
        const reviews = dbData.reviews.filter(rv => rv.restaurantId === id).sort((a,b) => new Date(b.date) - new Date(a.date));
        
        const galleryHtml = (r.gallery && r.gallery.length > 0) ? `<div class="mt-6"><h3 class="font-bold mb-2">üì∏ ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><div class="grid grid-cols-3 gap-2">${r.gallery.map(img => `<img src="${img}" class="w-full h-24 object-cover rounded-lg cursor-pointer" onclick="openImageViewer('${img}')">`).join('')}</div></div>` : '';
        
        // Map Link Logic
        const mapBtn = r.mapUrl 
            ? `<a href="${r.mapUrl}" target="_blank" class="w-full mt-4 py-2 bg-blue-500 text-white rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-blue-600"><i class="fa-solid fa-map-location-dot"></i> ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>` 
            : `<button disabled class="w-full mt-4 py-2 bg-gray-200 text-gray-400 rounded-lg cursor-not-allowed">üö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>`;

        const reviewsHtml = `<div class="mt-8 pt-6 border-t"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">üí¨ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (${reviews.length})</h3><span class="text-yellow-500 font-bold">‚≠ê ${stats.avg}</span></div>
        <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-6"><div class="flex gap-2 mb-2 star-rating" id="reviewStarInput">${[1,2,3,4,5].map(i => `<i class="fa-solid fa-star text-2xl inactive" onclick="setReviewRating(${i})" data-val="${i}"></i>`).join('')}</div><input type="text" id="reviewAuthor" class="w-full mb-2 px-3 py-1 border rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"><textarea id="reviewText" rows="2" class="w-full mb-2 px-3 py-1 border rounded" placeholder="‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥..."></textarea><button onclick="submitReview('${r.__backendId}')" class="bg-orange-500 text-white px-4 py-1 rounded font-bold">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button></div>
        <div class="space-y-3">${reviews.length===0?'<p class="text-gray-400 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>':reviews.map(rv=>`<div class="bg-gray-50 p-3 rounded-lg flex gap-3"><div class="w-8 h-8 rounded-full bg-orange-200 flex items-center justify-center text-orange-600 font-bold shrink-0">${rv.author.charAt(0)}</div><div><div class="flex items-center gap-2"><span class="font-bold text-sm">${rv.author}</span><span class="text-yellow-500 text-xs">‚≠ê ${rv.rating}</span></div><p class="text-xs text-gray-600">${rv.text}</p></div></div>`).join('')}</div></div>`;

        document.getElementById('restaurantDetailContent').innerHTML = `
            <div class="relative h-64 bg-gray-200 group">${r.coverImage ? `<img src="${r.coverImage}" class="w-full h-full object-cover cursor-pointer" onclick="openImageViewer('${r.coverImage}')">` : ''}<div class="absolute bottom-0 p-6 w-full bg-gradient-to-t from-black/80 to-transparent text-white"><span class="bg-orange-500 px-2 py-0.5 rounded text-xs font-bold">${r.category}</span><h1 class="text-2xl font-bold mt-1">${r.name}</h1><p class="text-sm opacity-90">üìç ${r.zone} | üïí ${r.openTime}-${r.closeTime}</p></div></div>
            <div class="p-6 text-gray-700"><p>${r.description || '-'}</p><div class="mt-4 text-sm"><b>üìû ‡πÇ‡∏ó‡∏£:</b> <a href="tel:${r.phone}">${r.phone||'-'}</a></div>${mapBtn}${galleryHtml}${reviewsHtml}</div>
        `;
        showPage('detail');
        setReviewRating(0);
    }
    
    function setReviewRating(val) { currentReviewRating = val; document.querySelectorAll('#reviewStarInput i').forEach(star => { const v=parseInt(star.dataset.val); star.className=`fa-solid fa-star text-2xl ${v<=val?'active':'inactive'}`; }); }
    async function submitReview(rId) { if(currentReviewRating===0)return alert('‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢'); const t=document.getElementById('reviewText').value, a=document.getElementById('reviewAuthor').value||'Guest'; await create('reviews', {restaurantId:rId, rating:currentReviewRating, text:t, author:a, date:new Date().toISOString()}); viewDetail(rId); }

    // --- ADMIN ---
    function handleLogin() { const u=document.getElementById('loginUsername').value, p=document.getElementById('loginPassword').value; const user=dbData.users.find(x => x.username===u && x.password===p); if(user){ currentUser=user; document.getElementById('adminNameDisplay').innerText=u; renderAdminTabs(); showPage('admin'); } else alert('‡∏ú‡∏¥‡∏î'); }
    function renderAdminTabs() { 
        const r=currentUser.role; 
        document.getElementById('btnAddRest').style.display=(r==='owner'||r==='moderator')?'block':'none';
        document.querySelectorAll('#adminPage button[id^="tab"]').forEach(b => { b.classList.remove('text-orange-500','border-b-2','border-orange-500'); b.classList.add('text-gray-500'); });
        const startTab = (r==='owner'||r==='moderator') ? 'Rest' : 'Review';
        document.getElementById('tab'+startTab+'Btn').classList.add('text-orange-500','border-b-2','border-orange-500');
        switchAdminTab(startTab==='Rest'?'restaurants':'reviews');
    }
    function switchAdminTab(t) { document.querySelectorAll('.admin-tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden'); if(t==='restaurants')renderAdminRestaurants(); if(t==='reviews')renderAdminReviews(); }
    
    function renderAdminRestaurants() { document.getElementById('adminRestaurantList').innerHTML=dbData.restaurants.map(r=>`<div class="flex justify-between items-center p-3 bg-white rounded shadow-sm border"><div class="flex items-center gap-3"><img src="${r.coverImage||''}" class="w-10 h-10 rounded bg-gray-200 object-cover"><span class="font-bold">${r.name}</span></div><div class="flex gap-2"><button onclick='showRestaurantForm(${JSON.stringify(r).replace(/'/g, "\\'")})' class="text-blue-500 text-sm font-bold">‡πÅ‡∏Å‡πâ</button><button onclick="deleteItem('restaurants','${r.__backendId}')" class="text-red-500 text-sm font-bold">‡∏•‡∏ö</button></div></div>`).join(''); }
    function renderAdminReviews() { document.getElementById('adminReviewList').innerHTML=dbData.reviews.map(rv=>`<div class="p-3 bg-white rounded shadow-sm border mb-2"><div class="flex justify-between"><span class="font-bold">${dbData.restaurants.find(r=>r.__backendId===rv.restaurantId)?.name}</span><span class="text-yellow-500">‚≠ê ${rv.rating}</span></div><p class="text-xs text-gray-500">"${rv.text}" - ${rv.author}</p><div class="text-right"><button onclick="deleteItem('reviews','${rv.__backendId}')" class="text-red-500 text-xs font-bold">‡∏•‡∏ö</button></div></div>`).join(''); }

    // --- FORM ---
    function showRestaurantForm(r=null) { editingItem=r; document.getElementById('restaurantFormTitle').innerText=r?'‡πÅ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô':'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô'; ['Name','Category','Zone','Description','Address','Phone','OpenTime','CloseTime','MapUrl'].forEach(k => document.getElementById('form'+k).value = r?(r[k.toLowerCase().replace('name','name').replace('time','Time').replace('mapurl','mapUrl')]||''):''); coverImg=r?.coverImage||''; galleryImgs=r?.gallery?[...r.gallery]:[]; updatePreviews(); document.getElementById('restaurantModal').classList.remove('hidden'); document.getElementById('restaurantModal').classList.add('flex'); }
    function closeRestaurantForm() { document.getElementById('restaurantModal').classList.add('hidden'); document.getElementById('restaurantModal').classList.remove('flex'); }
    async function saveRestaurant() { const name=document.getElementById('formName').value; if(!name)return alert('‡∏ä‡∏∑‡πà‡∏≠?'); const data={name,category:document.getElementById('formCategory').value,zone:document.getElementById('formZone').value,description:document.getElementById('formDescription').value,address:document.getElementById('formAddress').value,phone:document.getElementById('formPhone').value,openTime:document.getElementById('formOpenTime').value,closeTime:document.getElementById('formCloseTime').value,mapUrl:document.getElementById('formMapUrl').value,coverImage:coverImg,gallery:galleryImgs}; editingItem?await update('restaurants',{...editingItem,...data}):await create('restaurants',data); closeRestaurantForm(); }
    async function deleteItem(col,id) { if(confirm('‡∏•‡∏ö?')) await remove(col,id); }
    function handleLogout() { currentUser=null; showPage('home'); }

    // --- IMAGE UTILS ---
    function resizeImage(file, max=600) { return new Promise(r => { const reader=new FileReader(); reader.onload=e=>{ const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); const ratio=max/img.width; c.width=max; c.height=img.height*ratio; c.getContext('2d').drawImage(img,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.7)); }; img.src=e.target.result; }; reader.readAsDataURL(file); }); }
    function handleCoverUpload(e) { resizeImage(e.target.files[0]).then(b64 => { coverImg=b64; updatePreviews(); }); }
    async function handleGalleryUpload(e) { for(let f of e.target.files) galleryImgs.push(await resizeImage(f,500)); updatePreviews(); }
    function removeCoverImage() { coverImg=''; updatePreviews(); }
    function removeGalleryImage(i) { galleryImgs.splice(i,1); updatePreviews(); }
    function updatePreviews() { 
        document.getElementById('coverPreview').className = coverImg ? 'block mb-2' : 'hidden';
        document.getElementById('coverPreviewImg').src = coverImg;
        document.getElementById('galleryPreviewGrid').innerHTML = galleryImgs.map((img,i) => `<div class="relative h-16 bg-gray-100 rounded overflow-hidden"><img src="${img}" class="w-full h-full object-cover"><button onclick="removeGalleryImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 flex items-center justify-center text-xs">√ó</button></div>`).join('');
    }
    function openImageViewer(src) { document.getElementById('fullImage').src=src; document.getElementById('imageViewerModal').classList.remove('hidden'); }
    function closeImageViewer() { document.getElementById('imageViewerModal').classList.add('hidden'); }
  </script>
 </body>
</html>
