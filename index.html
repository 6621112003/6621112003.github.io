<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô (Pro)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    /* Custom Theme */
    :root {
        --primary: #FF6B6B;
        --secondary: #FFD93D;
        --accent: #4D96FF;
        --glass: rgba(255, 255, 255, 0.9);
    }
    body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #FFF5E1 0%, #FFEEE4 100%); overflow-x: hidden; }
    
    /* Glassmorphism Cards */
    .glass-panel {
        background: var(--glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px 0 rgba(255, 107, 107, 0.1);
    }

    /* Transitions & Animations */
    .page-transition { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .card-zoom { transition: transform 0.3s, box-shadow 0.3s; }
    .card-zoom:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(255, 107, 107, 0.2); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #FFD93D; border-radius: 10px; }
    
    /* Category Button */
    .cat-btn { transition: all 0.2s; border: 1px solid #eee; }
    .cat-btn.active { background: #FF6B6B; color: white; border-color: #FF6B6B; transform: scale(1.05); box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); }
    
    /* Star Rating */
    .star-rating i { cursor: pointer; transition: transform 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .star-rating i:hover { transform: scale(1.2); }
    .star-rating i.active { color: #FFD93D; }
    .star-rating i.inactive { color: #E0E0E0; }
  </style>
 </head>
 <body class="h-full text-gray-700">
  <div id="app" class="h-full overflow-auto">
   
   <div id="loadingScreen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white/80 backdrop-blur-md transition-opacity duration-500">
    <div class="relative">
        <div class="w-16 h-16 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin"></div>
        <div class="absolute top-0 left-0 w-16 h-16 flex items-center justify-center text-xl animate-pulse">üçî</div>
    </div>
    <p class="mt-4 font-bold text-orange-500 animate-pulse" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢...</p>
   </div>

   <div id="mainContent" class="hidden opacity-0 transition-opacity duration-500">
    
    <nav class="sticky top-0 z-40 glass-panel border-b-0 shadow-sm">
     <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2 cursor-pointer group" onclick="showPage('home')">
       <span class="text-3xl transform group-hover:scale-110 transition">üç±</span>
       <div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">FoodHunter</h1>
       </div>
      </div>
      <div class="flex gap-2">
       <button onclick="showPage('home')" class="px-4 py-2 rounded-full bg-white hover:bg-orange-50 text-gray-600 font-bold text-sm shadow-sm transition flex items-center gap-2"><i class="fa-solid fa-house"></i> <span class="hidden md:inline">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span></button> 
       <button id="adminBtn" onclick="checkAdminAccess()" class="px-4 py-2 rounded-full bg-gray-800 text-white font-bold text-sm shadow-lg hover:bg-black transition flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> <span class="hidden md:inline">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</span></button>
      </div>
     </div>
    </nav>

    <div id="homePage" class="page page-transition">
     <div class="relative pt-12 pb-20 px-4 text-center overflow-hidden">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-64 bg-gradient-to-r from-orange-400 via-red-400 to-pink-500 opacity-10 blur-3xl rounded-full -z-10"></div>
        <h2 class="text-4xl md:text-6xl font-bold text-gray-800 mb-4 drop-shadow-sm">‡∏´‡∏¥‡∏ß‡πÑ‡∏´‡∏°? <span class="text-orange-500">‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏î‡∏µ</span></h2>
        <p class="text-gray-500 mb-8 text-lg">‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏õ‡∏±‡∏á ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</p>
        
        <div class="max-w-2xl mx-auto glass-panel rounded-full p-2 flex items-center shadow-lg transform transition focus-within:scale-105">
            <span class="pl-4 text-orange-400 text-xl"><i class="fa-solid fa-search"></i></span>
            <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." class="flex-1 px-4 py-2 bg-transparent outline-none text-gray-700 placeholder-gray-400" oninput="filterRestaurants()">
            <button onclick="getLocation()" class="bg-orange-500 hover:bg-orange-600 text-white w-10 h-10 rounded-full flex items-center justify-center transition shadow-md" title="‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô"><i class="fa-solid fa-location-crosshairs"></i></button>
        </div>
        <p id="locationStatus" class="text-sm text-orange-500 mt-2 h-5 font-medium"></p>
     </div>

     <div class="max-w-7xl mx-auto px-4 pb-24">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
        <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 hide-scrollbar">
            <button onclick="setCategory('')" class="cat-btn active px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="setCategory('‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">üçú ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</button>
            <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">üç≥ ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á</button>
            <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">üç£ ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</button>
            <button onclick="setCategory('‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
            <button onclick="setCategory('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">‚òï ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
            <button onclick="setCategory('‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-gray-600 whitespace-nowrap">üçñ ‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå</button>
        </div>
        <select id="zoneFilter" onchange="filterRestaurants()" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-bold text-gray-600 focus:outline-none focus:border-orange-500 shadow-sm bg-white cursor-pointer hover:bg-gray-50"><option value="">üìç ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø</option></select>
      </div>

      <div id="restaurantGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
      
      <div id="emptyState" class="hidden text-center py-24">
        <div class="text-6xl mb-4 grayscale opacity-30">üçΩÔ∏è</div>
        <p class="text-xl text-gray-400 font-light">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
      </div>
     </div>
    </div>

    <div id="detailPage" class="page hidden page-transition">
     <div class="max-w-5xl mx-auto px-4 py-8">
       <button onclick="showPage('home')" class="mb-6 px-5 py-2 bg-white rounded-full shadow-sm text-gray-600 hover:text-orange-500 font-bold transition flex items-center gap-2 text-sm"><i class="fa-solid fa-chevron-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
       <div id="restaurantDetailContent" class="glass-panel rounded-[2rem] overflow-hidden min-h-[60vh] bg-white"></div>
     </div>
    </div>

    <div id="loginPage" class="page hidden page-transition">
     <div class="min-h-screen flex items-center justify-center px-4 -mt-20">
      <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-sm text-center relative overflow-hidden">
       <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-500 to-red-500"></div>
       <div class="mb-6 inline-block p-4 rounded-full bg-orange-50 text-4xl shadow-inner">üîê</div>
       <h2 class="text-2xl font-bold mb-2 text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
       <p class="text-gray-400 text-sm mb-8">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
       
       <div class="space-y-4">
           <input type="text" id="loginUsername" class="w-full px-5 py-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-orange-400 bg-gray-50 focus:bg-white transition" placeholder="Username">
           <input type="password" id="loginPassword" class="w-full px-5 py-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-orange-400 bg-gray-50 focus:bg-white transition" placeholder="Password">
           <button onclick="handleLogin()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-bold shadow-lg hover:shadow-orange-500/30 transform hover:-translate-y-1 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
       </div>
       <p class="text-xs text-gray-400 mt-6 cursor-pointer hover:text-orange-500" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</p>
      </div>
     </div>
    </div>

    <div id="adminPage" class="page hidden page-transition">
     <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="glass-panel rounded-3xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6 bg-white">
       <div>
           <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
               <span class="bg-orange-100 text-orange-600 p-2 rounded-lg"><i class="fa-solid fa-sliders"></i></span> 
               ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
           </h2>
           <p class="text-sm text-gray-500 mt-2 ml-1">
               ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <span id="adminNameDisplay" class="text-gray-800 font-bold"></span> 
               <span id="adminRoleBadge" class="ml-2 px-2 py-0.5 rounded text-[10px] uppercase font-bold text-white bg-gray-400">Role</span>
           </p>
       </div>
       <div class="flex gap-3 flex-wrap justify-center">
         <button onclick="showEditUserModal()" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 transition text-sm flex items-center gap-2"><i class="fa-solid fa-key"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
         <button onclick="showRestaurantForm()" id="btnAddRest" class="hidden px-5 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl shadow-lg hover:shadow-green-500/30 font-bold transition transform hover:-translate-y-1 flex items-center gap-2"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
         <button onclick="handleLogout()" class="px-4 py-2 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition text-sm flex items-center gap-2"><i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å</button>
       </div>
      </div>

      <div class="flex gap-2 mb-6 border-b border-gray-200 pb-1 overflow-x-auto">
          <button id="tabRestBtn" onclick="switchAdminTab('restaurants')" class="px-6 py-2 rounded-t-xl font-bold text-sm transition text-gray-500 border-b-2 border-transparent hover:bg-gray-50">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="tabReviewBtn" onclick="switchAdminTab('reviews')" class="px-6 py-2 rounded-t-xl font-bold text-sm transition text-gray-500 border-b-2 border-transparent hover:bg-gray-50">üí¨ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
          <button id="tabUserBtn" onclick="switchAdminTab('users')" class="px-6 py-2 rounded-t-xl font-bold text-sm transition text-gray-500 border-b-2 border-transparent hover:bg-gray-50">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
      </div>

      <div id="adminTabRestaurants" class="admin-tab-content hidden"><div id="adminRestaurantList" class="space-y-4"></div></div>
      <div id="adminTabReviews" class="admin-tab-content hidden"><div id="adminReviewList" class="space-y-4"></div></div>
      <div id="adminTabUsers" class="admin-tab-content hidden">
          <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-lg text-gray-700 border-l-4 border-orange-500 pl-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
              <button onclick="showUserForm()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-600 transition flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </div>
          <div id="adminUserList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>
     </div>
    </div>

    <div id="restaurantModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
     <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-100 transition-transform">
      <div class="p-6 md:p-8">
       <div class="flex justify-between items-center mb-6 border-b pb-4"><h3 id="restaurantFormTitle" class="text-xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3><button onclick="closeModal('restaurantModal')" class="text-3xl text-gray-300 hover:text-red-500 transition">√ó</button></div>
       <div class="space-y-5">
        <div><label class="text-sm font-bold text-gray-600 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô *</label><input type="text" id="formName" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-orange-500 transition bg-gray-50 focus:bg-white"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label><select id="formCategory" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-orange-500 bg-gray-50"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option><option value="‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß">‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</option><option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option><option value="‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå">‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå</option></select></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">‡πÄ‡∏Ç‡∏ï *</label><select id="formZone" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-orange-500 bg-gray-50"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option></select></div>
        </div>
        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <label class="text-sm font-bold text-blue-800 mb-1 block"><i class="fa-solid fa-map-location-dot"></i> ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Google Maps)</label>
            <input type="url" id="formMapUrl" class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-300 text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (https://maps.app.goo.gl/...)">
        </div>
        <div><label class="text-sm font-bold text-gray-600 mb-1 block">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="formDescription" rows="3" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-orange-500 bg-gray-50"></textarea></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="text-sm font-bold text-gray-600 mb-1 block">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input type="text" id="formAddress" class="w-full px-4 py-2 border rounded-xl outline-none bg-gray-50"></div>
            <div><label class="text-sm font-bold text-gray-600 mb-1 block">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="formPhone" class="w-full px-4 py-2 border rounded-xl outline-none bg-gray-50"></div>
        </div>
        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
            <div><label class="text-xs text-gray-500 mb-1 block">‡πÄ‡∏õ‡∏¥‡∏î</label><input type="time" id="formOpenTime" class="w-full border rounded px-2 py-1 bg-white"></div>
            <div><label class="text-xs text-gray-500 mb-1 block">‡∏õ‡∏¥‡∏î</label><input type="time" id="formCloseTime" class="w-full border rounded px-2 py-1 bg-white"></div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border-2 border-dashed border-orange-200 rounded-xl p-4 bg-orange-50/50 text-center hover:bg-orange-50 transition cursor-pointer" onclick="document.getElementById('coverImageInput').click()">
                <label class="block font-bold mb-2 text-orange-800 cursor-pointer">üì∑ ‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏´‡∏•‡∏±‡∏Å</label>
                <div id="coverPreview" class="hidden mb-2 relative h-32 bg-gray-200 rounded-lg overflow-hidden"><img id="coverPreviewImg" class="h-full w-full object-cover"></div>
                <div class="text-sm text-orange-500 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</div>
                <input type="file" id="coverImageInput" accept="image/*" onchange="handleCoverUpload(event)" class="hidden">
            </div>
            <div class="border-2 border-dashed border-blue-200 rounded-xl p-4 bg-blue-50/50 text-center hover:bg-blue-50 transition cursor-pointer" onclick="document.getElementById('galleryImageInput').click()">
                <label class="block font-bold mb-2 text-blue-800 cursor-pointer">üñºÔ∏è ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ</label>
                <div id="galleryPreviewGrid" class="grid grid-cols-4 gap-1 mb-2"></div>
                <div class="text-sm text-blue-500 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</div>
                <input type="file" id="galleryImageInput" accept="image/*" multiple onchange="handleGalleryUpload(event)" class="hidden">
            </div>
        </div>

        <div class="flex gap-3 pt-6 border-t mt-4">
            <button onclick="closeModal('restaurantModal')" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="saveRestaurant()" id="saveRestaurantBtn" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
       </div>
      </div>
     </div>
    </div>

    <div id="userModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
         <h3 class="text-xl font-bold mb-4 text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
         <div class="space-y-4">
             <div><label class="text-xs text-gray-500 block mb-1">Username</label><input type="text" id="formUsername" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-blue-500 bg-gray-50"></div>
             <div><label class="text-xs text-gray-500 block mb-1">Password</label><input type="text" id="formPassword" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-blue-500 bg-gray-50"></div>
             <div>
                 <label class="text-xs text-gray-500 block mb-1">Role (‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)</label>
                 <select id="formRole" class="w-full px-4 py-2 border rounded-xl outline-none focus:border-blue-500 bg-white">
                     <option value="owner">üëë Owner (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</option>
                     <option value="moderator">üõ†Ô∏è Moderator (‡∏Ñ‡∏∏‡∏°‡∏£‡πâ‡∏≤‡∏ô/‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</option>
                     <option value="inspector">üîç Inspector (‡∏î‡∏π‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</option>
                 </select>
             </div>
         </div>
         <div class="flex gap-3 mt-6"><button onclick="closeModal('userModal')" class="flex-1 py-2 bg-gray-100 rounded-lg font-bold text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="saveUser()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg font-bold shadow hover:bg-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>

    <div id="editProfileModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
         <h3 class="text-xl font-bold mb-4 text-gray-800">üë§ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
         <div class="space-y-4">
           <div><label class="text-xs text-gray-500 block mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input type="text" id="editProfileName" class="w-full px-4 py-2 border rounded-xl bg-gray-100 text-gray-500 cursor-not-allowed" readonly></div>
           <div><label class="text-xs text-gray-500 block mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="text" id="editProfilePass" class="w-full px-4 py-2 border border-gray-300 rounded-xl outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà"></div>
         </div>
         <div class="flex gap-3 mt-6"><button onclick="closeModal('editProfileModal')" class="flex-1 py-2 bg-gray-100 rounded-lg font-bold text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="saveUserUpdate()" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-bold shadow hover:bg-green-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
        </div>
    </div>

    <div id="imageViewerModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[90] cursor-zoom-out backdrop-blur-md" onclick="closeImageViewer()"><div class="relative w-full h-full flex items-center justify-center p-4"><img id="fullImage" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-transform duration-300 transform scale-95 opacity-0"><button onclick="closeImageViewer()" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-bold transition">√ó</button></div></div>
    
    <div id="cropModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl w-full max-w-4xl p-6 shadow-2xl"><h3 class="text-lg font-bold mb-4 text-gray-800">‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å</h3><div class="mb-4 h-[50vh] bg-gray-100 rounded-xl overflow-hidden border border-gray-300"><img id="cropImage" style="max-width: 100%;"></div><div class="flex gap-4"><button onclick="closeModal('cropModal')" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold hover:bg-gray-300 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="confirmCrop()" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</button></div></div></div>

   </div>
  </div>

  <script>
    // --- üî¥ CONFIG FIREBASE (‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHX9l4CYgX0BCFliagOnBCK1oFbu7sp9s",
      authDomain: "rattawut-food.firebaseapp.com",
      projectId: "rattawut-food",
      storageBucket: "rattawut-food.firebasestorage.app",
      messagingSenderId: "928937247925",
      appId: "1:928937247925:web:5d58ca32296f841a126afc",
      databaseURL: "https://rattawut-food-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Global Error Handler
    window.onerror = function(msg, url, line) {
        // Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: msg });
        return false;
    };

    // Initialize Firebase
    if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); } }
    const db = firebase.database();

    // --- CONFIG & DATA ---
    const districts = ["‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£", "‡∏î‡∏∏‡∏™‡∏¥‡∏ï", "‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å", "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å", "‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô", "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô", "‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢", "‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á", "‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á", "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤", "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå", "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó", "‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà", "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô", "‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô", "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô", "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°", "‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞", "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î", "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á", "‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°", "‡∏™‡∏≤‡∏ó‡∏£", "‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠", "‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£", "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°", "‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®", "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢", "‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á", "‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á", "‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ", "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà", "‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°", "‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß", "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á", "‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤", "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤", "‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏", "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô"];
    let dbData = { restaurants:[], reviews:[], users:[] };
    let currentUser = null, editingItem = null, editingUser = null;
    let categoryFilter = '', coverImg = '', galleryImgs = [], cropper = null;
    let currentReviewRating = 0;

    // --- MAIN STARTUP ---
    window.onload = function() {
        // Setup UI
        const z = document.getElementById('zoneFilter'), fz = document.getElementById('formZone');
        districts.sort().forEach(d => { 
            const opt = `<option value="${d}">${d}</option>`;
            z.innerHTML += opt; fz.innerHTML += opt; 
        });
        
        // Start Sync
        startRealtimeSync();
    };

    function startRealtimeSync() {
        document.getElementById('loadingText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        
        // 1. Restaurants
        db.ref('restaurants').on('value', (s) => { 
            const val = s.val();
            dbData.restaurants = val ? Object.keys(val).map(k => ({...val[k], __backendId: k})) : [];
            renderGrid(dbData.restaurants);
            if(currentUser) renderAdminRestaurants();
            hideLoader();
        });

        // 2. Reviews
        db.ref('reviews').on('value', (s) => { 
            const val = s.val();
            dbData.reviews = val ? Object.keys(val).map(k => ({...val[k], __backendId: k})) : [];
            if(currentUser) renderAdminReviews();
            // Optional: Auto refresh detail page if open
        });
        
        // 3. Users
        db.ref('users').on('value', (s) => { 
            const val = s.val();
            dbData.users = val ? Object.keys(val).map(k => ({...val[k], __backendId: k})) : [];
            // Auto-create defaults if empty
            if(dbData.users.length === 0) {
                create('users', { username: 'owner', password: '1234', role: 'owner' });
                create('users', { username: 'moderator', password: '1234', role: 'moderator' });
                create('users', { username: 'inspector', password: '1234', role: 'inspector' });
            }
            if(currentUser) renderAdminUsers();
        });
    }

    function hideLoader() {
        const loader = document.getElementById('loadingScreen');
        if(loader.style.display === 'none') return;
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
            setTimeout(() => document.getElementById('mainContent').classList.remove('opacity-0'), 50);
            showPage('home');
        }, 500);
    }

    // --- CRUD ---
    function create(col, item) { return db.ref(col).push(item); }
    function update(col, id, item) { return db.ref(col + '/' + id).update(item); }
    function remove(col, id) { return db.ref(col + '/' + id).remove(); }

    // --- FRONTEND LOGIC ---
    function showPage(p) { document.querySelectorAll('.page').forEach(x => { x.classList.add('hidden'); }); const t = document.getElementById(p + 'Page'); t.classList.remove('hidden'); window.scrollTo(0,0); }
    function setCategory(c) { categoryFilter = c; document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(c) || (c==='' && b.innerText==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'))); filterRestaurants(); }

    function filterRestaurants() {
        const s = document.getElementById('searchInput').value.toLowerCase();
        const z = document.getElementById('zoneFilter').value;
        let list = dbData.restaurants.filter(r => (!s || r.name.toLowerCase().includes(s)) && (!categoryFilter || r.category === categoryFilter) && (!z || r.zone === z));
        // Sort by Rating
        list.sort((a,b) => getRating(b.__backendId).avg - getRating(a.__backendId).avg);
        renderGrid(list);
    }
    
    function renderGrid(list) {
        const g = document.getElementById('restaurantGrid'), e = document.getElementById('emptyState');
        if(!list || list.length===0) { g.innerHTML=''; e.classList.remove('hidden'); return; }
        e.classList.add('hidden');
        g.innerHTML = list.map(r => {
            const stats = getRating(r.__backendId);
            return `
            <div class="glass-panel rounded-[1.5rem] overflow-hidden card-zoom cursor-pointer group bg-white" onclick="viewDetail('${r.__backendId}')">
                <div class="h-52 bg-gray-100 relative overflow-hidden">
                     ${r.coverImage ? `<div class="w-full h-full bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image:url('${r.coverImage}')"></div>` : `<div class="flex items-center justify-center h-full text-4xl bg-orange-50 text-orange-200">üçú</div>`}
                     <div class="absolute top-3 left-3 bg-white/95 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-orange-600 shadow-sm border border-orange-100">${r.category}</div>
                     <div class="absolute top-3 right-3 bg-black/60 backdrop-blur-sm px-2 py-1 rounded-lg text-xs font-bold text-yellow-300 shadow-sm flex items-center gap-1 border border-white/20"><i class="fa-solid fa-star"></i> ${stats.avg} (${stats.count})</div>
                </div>
                <div class="p-5">
                    <h3 class="font-bold text-xl text-gray-800 mb-1 leading-tight group-hover:text-orange-500 transition">${r.name}</h3>
                    <div class="text-sm text-gray-500 mb-3 flex items-center gap-1"><span class="text-red-500"><i class="fa-solid fa-location-dot"></i></span> ${r.zone}</div>
                    <p class="text-gray-500 text-sm line-clamp-2 h-10 opacity-80">${r.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</p>
                </div>
            </div>`;
        }).join('');
    }
    
    function getRating(rId) { 
        const revs = dbData.reviews.filter(r => r.restaurantId === rId); 
        if(revs.length === 0) return { avg: "0.0", count: 0 }; 
        const sum = revs.reduce((a, b) => a + (parseInt(b.rating)||0), 0);
        return { avg: (sum / revs.length).toFixed(1), count: revs.length }; 
    }

    function viewDetail(id) {
        const r = dbData.restaurants.find(i => i.__backendId === id); if(!r) return;
        const stats = getRating(id);
        const reviews = dbData.reviews.filter(rv => rv.restaurantId === id).sort((a,b) => new Date(b.date) - new Date(a.date));
        
        const galleryHtml = (r.gallery && r.gallery.length > 0) ? `<div class="mt-8"><h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700"><i class="fa-regular fa-images text-orange-500"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3">${r.gallery.map(img => `<div class="aspect-square rounded-2xl overflow-hidden shadow-sm cursor-zoom-in group relative" onclick="openImageViewer('${img}')"><img src="${img}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110"></div>`).join('')}</div></div>` : '';
        const mapBtn = r.mapUrl ? `<a href="${r.mapUrl}" target="_blank" class="w-full mt-4 py-3 bg-blue-500 text-white rounded-xl font-bold shadow-lg hover:bg-blue-600 transition flex items-center justify-center gap-2 transform active:scale-95"><i class="fa-solid fa-map-location-dot"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Google Maps)</a>` : '';

        const reviewsHtml = `<div class="mt-10 pt-8 border-t border-dashed border-gray-200"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800">üí¨ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="text-base font-normal text-gray-500">(${reviews.length})</span></h3><div class="bg-yellow-50 px-3 py-1 rounded-lg border border-yellow-100 text-yellow-600 font-bold"><i class="fa-solid fa-star"></i> ${stats.avg}/5</div></div>
        <div class="bg-gradient-to-br from-orange-50 to-white p-6 rounded-2xl border border-orange-100 mb-8 shadow-sm">
            <h4 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</h4>
            <div class="flex gap-2 mb-4 star-rating" id="reviewStarInput">${[1,2,3,4,5].map(i => `<i class="fa-solid fa-star text-3xl inactive transition hover:scale-110" onclick="setReviewRating(${i})" data-val="${i}"></i>`).join('')}</div>
            <input type="text" id="reviewAuthor" class="w-full mb-3 px-4 py-2.5 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡πá‡πÑ‡∏î‡πâ)">
            <textarea id="reviewText" rows="2" class="w-full mb-3 px-4 py-2.5 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?"></textarea>
            <button onclick="submitReview('${r.__backendId}')" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-2.5 rounded-xl font-bold hover:shadow-lg hover:-translate-y-0.5 transition w-full md:w-auto">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
        </div>
        <div class="space-y-4">${reviews.length === 0 ? '<div class="text-center py-8 bg-gray-50 rounded-2xl border border-dashed border-gray-200 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!</div>' : reviews.map(rv => `<div class="bg-white p-5 rounded-2xl flex gap-4 border border-gray-100 shadow-sm hover:shadow-md transition"><div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold shrink-0 shadow-inner">${rv.author.charAt(0).toUpperCase()}</div><div class="flex-1"><div class="flex justify-between items-start mb-1"><div><span class="font-bold text-gray-800 block">${rv.author}</span><div class="text-yellow-400 text-xs mt-0.5">${'<i class="fa-solid fa-star"></i>'.repeat(rv.rating)}</div></div><span class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded-full">${new Date(rv.date).toLocaleDateString('th-TH')}</span></div><p class="text-gray-600 text-sm mt-2 leading-relaxed">${rv.text}</p></div></div>`).join('')}</div></div>`;

        document.getElementById('restaurantDetailContent').innerHTML = `
            <div class="h-[45vh] w-full bg-gray-200 relative group overflow-hidden cursor-zoom-in" onclick="openImageViewer('${r.coverImage || ''}')">${r.coverImage ? `<div class="w-full h-full bg-cover bg-center" style="background-image:url('${r.coverImage}')"></div>` : `<div class="flex items-center justify-center h-full text-8xl bg-orange-100 text-orange-300">üçú</div>`}<div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div><div class="absolute bottom-0 left-0 right-0 p-8 text-white"><span class="bg-orange-500 px-3 py-1 rounded-full text-sm font-bold mb-3 inline-block shadow-lg border border-white/20">${r.category}</span><h1 class="text-3xl md:text-5xl font-bold mb-2 shadow-sm leading-tight">${r.name}</h1><p class="opacity-90 text-lg flex items-center gap-2"><i class="fa-solid fa-map-pin text-red-400"></i> ‡πÄ‡∏Ç‡∏ï${r.zone} <span class="mx-2 opacity-50">|</span> <i class="fa-regular fa-clock text-yellow-400"></i> ${r.openTime} - ${r.closeTime}</p></div></div>
            <div class="p-6 md:p-10"><div class="grid md:grid-cols-3 gap-10"><div class="md:col-span-2"><h3 class="font-bold text-gray-800 mb-3 text-xl border-b pb-2 border-gray-100">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡πâ‡∏≤‡∏ô</h3><p class="text-gray-600 leading-relaxed text-lg">${r.description || '-'}</p>${galleryHtml}${reviewsHtml}</div><div class="md:col-span-1"><div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm sticky top-24"><h4 class="font-bold text-gray-800 mb-4 text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h4><ul class="space-y-4 text-gray-600"><li><div class="text-xs text-gray-400 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div><div class="font-medium flex gap-2"><i class="fa-solid fa-location-dot text-red-500 mt-1"></i> ${r.address || '-'}</div></li><li><div class="text-xs text-gray-400 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div><a href="tel:${r.phone}" class="font-bold text-lg text-orange-600 hover:text-orange-700 flex gap-2 items-center"><i class="fa-solid fa-phone"></i> ${r.phone || '-'}</a></li></ul>${mapBtn}</div></div></div></div>
        `;
        showPage('detail');
        setReviewRating(0);
    }
    
    function setReviewRating(val) { currentReviewRating = val; document.querySelectorAll('#reviewStarInput i').forEach(star => { const v=parseInt(star.dataset.val); star.className=`fa-solid fa-star text-3xl transition ${v<=val?'active text-yellow-400':'inactive text-gray-200'}`; }); }
    async function submitReview(rId) { 
        if(currentReviewRating===0) return Swal.fire('‡∏•‡∏∑‡∏°‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß', 'warning');
        const t=document.getElementById('reviewText').value, a=document.getElementById('reviewAuthor').value||'Guest'; 
        await create('reviews', {restaurantId:rId, rating:currentReviewRating, text:t, author:a, date:new Date().toISOString()}); 
        Swal.fire('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì!', '‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
        viewDetail(rId); 
    }

    // --- ADMIN ---
    function checkAdminAccess() { currentUser ? showPage('admin') : showPage('login'); }
    function handleLogin() { 
        const u=document.getElementById('loginUsername').value, p=document.getElementById('loginPassword').value; 
        const user=dbData.users.find(x => x.username===u && x.password===p); 
        if(user){ currentUser=user; document.getElementById('adminNameDisplay').innerText=u; document.getElementById('adminRoleBadge').innerText=user.role; renderAdminTabs(); showPage('admin'); } 
        else Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', 'error');
    }
    
    function renderAdminTabs() { 
        const r=currentUser.role; 
        document.getElementById('btnAddRest').style.display=(r==='owner'||r==='moderator')?'block':'none';
        
        // Tab Styles
        const tabs = ['Rest','Review','User'];
        tabs.forEach(t => {
            const btn = document.getElementById('tab'+t+'Btn');
            btn.classList.remove('text-orange-500','border-orange-500','border-b-2');
            btn.classList.add('text-gray-500');
            btn.onclick = () => {
                tabs.forEach(x => document.getElementById('tab'+x+'Btn').classList.remove('text-orange-500','border-orange-500','border-b-2'));
                btn.classList.add('text-orange-500','border-orange-500','border-b-2');
                switchAdminTab(t.toLowerCase()+(t==='Rest'?'aurants':'s'));
            }
        });
        
        // Initial Tab
        if(r==='owner') { document.getElementById('tabUserBtn').style.display='block'; document.getElementById('tabRestBtn').click(); }
        else if(r==='moderator') { document.getElementById('tabUserBtn').style.display='none'; document.getElementById('tabRestBtn').click(); }
        else { document.getElementById('tabRestBtn').style.display='none'; document.getElementById('tabUserBtn').style.display='none'; document.getElementById('tabReviewBtn').click(); }
    }
    
    function switchAdminTab(t) { document.querySelectorAll('.admin-tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden'); if(t==='restaurants')renderAdminRestaurants(); if(t==='reviews')renderAdminReviews(); if(t==='users')renderAdminUsers(); }
    
    // Admin Renders
    function renderAdminRestaurants() { 
        document.getElementById('adminRestaurantList').innerHTML = dbData.restaurants.map(r => `
            <div class="flex flex-col md:flex-row justify-between items-center p-4 bg-white rounded-2xl shadow-sm border border-gray-100 gap-4">
                <div class="flex items-center gap-4 w-full">
                    <img src="${r.coverImage||''}" class="w-16 h-16 rounded-xl bg-gray-100 object-cover shadow-sm">
                    <div><div class="font-bold text-gray-800 text-lg">${r.name}</div><div class="text-sm text-gray-500">${r.category}</div></div>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick='showRestaurantForm(${JSON.stringify(r).replace(/'/g, "\\'")})' class="flex-1 md:flex-none px-4 py-2 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="deleteItem('restaurants','${r.__backendId}')" class="flex-1 md:flex-none px-4 py-2 bg-red-50 text-red-600 rounded-xl font-bold text-sm">‡∏•‡∏ö</button>
                </div>
            </div>`).join(''); 
    }
    function renderAdminReviews() { 
        document.getElementById('adminReviewList').innerHTML = dbData.reviews.map(rv => `
            <div class="p-5 bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-gray-800">${dbData.restaurants.find(r=>r.__backendId===rv.restaurantId)?.name||'Deleted'}</span>
                    <span class="text-yellow-500 font-bold">‚≠ê ${rv.rating}</span>
                </div>
                <p class="text-gray-600 text-sm mb-3 bg-gray-50 p-3 rounded-xl">"${rv.text}"</p>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-400">‡πÇ‡∏î‡∏¢ ${rv.author}</span>
                    <button onclick="deleteItem('reviews','${rv.__backendId}')" class="px-3 py-1 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100">‡∏•‡∏ö</button>
                </div>
            </div>`).join(''); 
    }
    function renderAdminUsers() { 
        document.getElementById('adminUserList').innerHTML = dbData.users.map(u => `
            <div class="p-4 bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-bold text-gray-800">${u.username}</div>
                        <span class="text-xs uppercase bg-gray-100 px-2 py-0.5 rounded text-gray-500 font-bold">${u.role}</span>
                    </div>
                    ${(currentUser.role==='owner' && u.username!=='admin') ? `<div class="flex gap-1"><button onclick='showUserForm(${JSON.stringify(u).replace(/'/g, "\\'")})' class="w-8 h-8 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('users','${u.__backendId}')" class="w-8 h-8 bg-red-50 text-red-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-trash"></i></button></div>` : ''}
                </div>
            </div>`).join(''); 
    }

    // --- FORM HANDLING ---
    function showRestaurantForm(r=null) { 
        editingItem=r; document.getElementById('restaurantFormTitle').innerText=r?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡πâ‡∏≤‡∏ô':'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'; 
        ['Name','Category','Zone','Description','Address','Phone','OpenTime','CloseTime','MapUrl'].forEach(k => document.getElementById('form'+k).value = r?(r[k.toLowerCase().replace('name','name').replace('time','Time').replace('mapurl','mapUrl')]||''):''); 
        coverImg=r?.coverImage||''; galleryImgs=r?.gallery?[...r.gallery]:[]; updatePreviews(); 
        document.getElementById('restaurantModal').classList.remove('hidden'); 
    }
    function showUserForm(u=null) { 
        editingUser=u; 
        document.getElementById('formUsername').value = u?u.username:''; 
        document.getElementById('formPassword').value = u?u.password:''; 
        document.getElementById('formRole').value = u?u.role:'inspector';
        document.getElementById('userModal').classList.remove('hidden'); 
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function handleLogout() { Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡∏Å?',icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed){currentUser=null;showPage('home');}}); }

    async function saveRestaurant() {
        const name=document.getElementById('formName').value; if(!name)return Swal.fire('Error','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô','error');
        const btn = document.getElementById('saveRestaurantBtn'); btn.innerText='‚è≥...'; btn.disabled=true;
        const data={name,category:document.getElementById('formCategory').value,zone:document.getElementById('formZone').value,description:document.getElementById('formDescription').value,address:document.getElementById('formAddress').value,phone:document.getElementById('formPhone').value,openTime:document.getElementById('formOpenTime').value,closeTime:document.getElementById('formCloseTime').value,mapUrl:document.getElementById('formMapUrl').value,coverImage:coverImg,gallery:galleryImgs};
        editingItem ? await update('restaurants', editingItem.__backendId, data) : await create('restaurants', data);
        btn.innerText='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; btn.disabled=false; closeModal('restaurantModal'); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
    }
    
    async function saveUser() {
        const u=document.getElementById('formUsername').value, p=document.getElementById('formPassword').value, r=document.getElementById('formRole').value;
        if(!u||!p)return;
        const data = {username:u, password:p, role:r};
        editingUser ? await update('users', editingUser.__backendId, data) : await create('users', data);
        closeModal('userModal'); Swal.fire('Success','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
    }

    async function deleteItem(col, id) {
        Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(async r=>{
            if(r.isConfirmed) { await remove(col, id); Swal.fire('Deleted!','‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß','success'); }
        });
    }

    // --- IMAGES ---
    function resizeImage(file, max=600) { return new Promise(r => { const reader=new FileReader(); reader.onload=e=>{ const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); const ratio=max/img.width; c.width=max; c.height=img.height*ratio; c.getContext('2d').drawImage(img,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.8)); }; img.src=e.target.result; }; reader.readAsDataURL(file); }); }
    function handleCoverUpload(e) { resizeImage(e.target.files[0]).then(b => { coverImg=b; updatePreviews(); }); }
    async function handleGalleryUpload(e) { for(let f of e.target.files) galleryImgs.push(await resizeImage(f,500)); updatePreviews(); }
    function removeCoverImage() { coverImg=''; updatePreviews(); }
    function removeGalleryImage(i) { galleryImgs.splice(i,1); updatePreviews(); }
    function updatePreviews() { 
        document.getElementById('coverPreview').className = coverImg ? 'block mb-2' : 'hidden';
        document.getElementById('coverPreviewImg').src = coverImg;
        document.getElementById('galleryPreviewGrid').innerHTML = galleryImgs.map((img,i) => `<div class="relative h-16 bg-gray-100 rounded overflow-hidden"><img src="${img}" class="w-full h-full object-cover"><button onclick="removeGalleryImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 flex items-center justify-center text-xs">√ó</button></div>`).join('');
    }
    function openImageViewer(src) { document.getElementById('fullImage').src=src; document.getElementById('imageViewerModal').classList.remove('hidden'); }
    function closeImageViewer() { document.getElementById('imageViewerModal').classList.add('hidden'); }
    
    // --- EDIT PROFILE ---
    function showEditUserModal() { document.getElementById('editProfileName').value = currentUser.username; document.getElementById('editProfileModal').classList.remove('hidden'); }
    async function saveUserUpdate() { const p=document.getElementById('editProfilePass').value; if(p) await update('users', currentUser.__backendId, {password:p}); closeModal('editProfileModal'); Swal.fire('Success','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß','success'); }
  </script>
 </body>
</html>
