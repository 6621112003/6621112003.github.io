<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πà‡∏≤‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô (Online)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body { font-family: 'Prompt', sans-serif; overflow-x: hidden; }
    .gradient-bg { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ffcc02 100%); }
    .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .page-enter { opacity: 0; transform: translateY(20px); }
    .page-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(255, 107, 53, 0.2); }
    .category-btn { transition: all 0.3s; }
    .category-btn.active { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; transform: scale(1.05); box-shadow: 0 4px 12px rgba(247, 147, 30, 0.4); }
    .star-rating i { cursor: pointer; transition: color 0.2s; }
    .star-rating i.active { color: #fbbf24; } 
    .star-rating i.inactive { color: #e5e7eb; } 
  </style>
 </head>
 <body class="h-full bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50">
  <div id="app" class="h-full overflow-auto">
   
   <div id="loadingScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-[100] transition-opacity duration-500">
    <div class="text-center text-white">
     <div class="text-6xl mb-4 animate-bounce">üì°</div>
     <div class="text-2xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
     <p id="loadingStatus" class="text-sm mt-2 opacity-80">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    </div>
   </div>

   <div id="mainContent" class="hidden opacity-0 transition-opacity duration-500">
    <nav class="glass-effect sticky top-0 z-40 shadow-lg">
     <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
       <div class="flex items-center gap-3 cursor-pointer" onclick="showPage('home')">
        <div class="text-4xl text-orange-500">üçú</div>
        <div><h1 class="text-xl font-bold bg-gradient-to-r from-orange-600 to-amber-500 bg-clip-text text-transparent">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢ (Online)</h1></div>
       </div>
       <div class="flex gap-2">
        <button onclick="showPage('home')" class="px-3 py-2 text-gray-600 hover:text-orange-500 font-medium text-sm md:text-base transition"><i class="fa-solid fa-house"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button> 
        <button id="adminBtn" onclick="showPage('login')" class="px-3 py-2 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-full font-medium shadow-md text-sm md:text-base hover:shadow-lg transition"><i class="fa-solid fa-lock"></i> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
       </div>
      </div>
     </div>
    </nav>

    <div id="homePage" class="page">
     <div class="gradient-bg py-12 px-4 text-center text-white rounded-b-[3rem] shadow-xl mb-8">
       <h2 class="text-3xl md:text-5xl font-bold mb-4 drop-shadow-md">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ‚ö°</h2>
       <div class="max-w-2xl mx-auto bg-white rounded-full p-2 flex shadow-2xl items-center">
         <span class="pl-4 py-2 text-2xl text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></span>
         <input type="text" id="searchInput" placeholder="‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ..." class="flex-1 px-4 py-2 outline-none text-gray-700 rounded-full text-lg" oninput="filterRestaurants()"> 
         <button onclick="getLocation()" class="bg-blue-500 text-white w-10 h-10 rounded-full hover:bg-blue-600 transition flex items-center justify-center mr-1"><i class="fa-solid fa-location-arrow"></i></button>
       </div>
       <p id="locationStatus" class="text-sm mt-2 opacity-80 h-5"></p>
     </div>
     <div class="max-w-7xl mx-auto px-4 pb-16">
      <div class="mb-6"><div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2" id="categoryFilters">
        <button onclick="setCategory('')" class="category-btn active whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button> 
        <button onclick="setCategory('‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß">üçú ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</button> 
        <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á">üç≥ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á</button> 
        <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô">üç£ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</button>
        <button onclick="setCategory('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô">üå∂Ô∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</button>
        <button onclick="setCategory('‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
        <button onclick="setCategory('‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‚òï ‡∏Å‡∏≤‡πÅ‡∏ü</button>
        <button onclick="setCategory('‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå')" class="category-btn whitespace-nowrap px-4 py-2 bg-white rounded-full shadow-md font-medium text-gray-600" data-category="‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå">üçñ ‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå</button>
      </div></div>
      <div class="mb-6 flex justify-end"><select id="zoneFilter" onchange="filterRestaurants()" class="w-full md:w-64 px-4 py-2 bg-white rounded-xl shadow border border-gray-100 outline-none focus:ring-2 focus:ring-orange-400 text-gray-700 cursor-pointer"><option value="">üìç ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø</option></select></div>
      <div id="restaurantGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="emptyState" class="hidden text-center py-16 text-gray-500 bg-white rounded-2xl shadow-sm border border-dashed border-gray-300"><div class="text-6xl mb-2">üçΩÔ∏è</div><p class="text-xl">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p></div>
     </div>
    </div>

    <div id="detailPage" class="page hidden opacity-0">
     <div class="max-w-5xl mx-auto px-4 py-8">
       <button onclick="showPage('home')" class="mb-4 px-4 py-2 bg-white rounded-full shadow text-gray-600 hover:text-orange-500 font-medium transition flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
       <div id="restaurantDetailContent" class="bg-white rounded-3xl shadow-2xl overflow-hidden pb-8 min-h-[50vh]"></div>
     </div>
    </div>

    <div id="loginPage" class="page hidden opacity-0">
     <div class="min-h-screen flex items-center justify-center px-4 -mt-20">
      <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center border-t-4 border-orange-500">
       <div class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-cloud"></i></div>
       <h2 class="text-2xl font-bold mb-4 text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Online)</h2>
       <input type="text" id="loginUsername" class="w-full mb-3 px-4 py-3 border border-gray-200 rounded-xl outline-none focus:border-orange-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
       <input type="password" id="loginPassword" class="w-full mb-6 px-4 py-3 border border-gray-200 rounded-xl outline-none focus:border-orange-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
       <button onclick="handleLogin()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-xl font-bold hover:shadow-lg transform transition active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
     </div>
    </div>

    <div id="adminPage" class="page hidden opacity-0">
     <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
       <div>
           <h2 class="text-2xl font-bold text-gray-800">üõ†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô <span class="text-xs text-green-500 bg-green-100 px-2 py-1 rounded-full">‚óè Online</span></h2>
           <p class="text-sm text-gray-500">Login: <span id="adminNameDisplay" class="text-orange-500 font-bold"></span> <span id="adminRoleBadge" class="ml-2 px-2 py-0.5 rounded text-xs font-bold text-white bg-gray-500">Role</span></p>
       </div>
       <div class="flex gap-2 flex-wrap justify-center">
         <button onclick="showRestaurantForm()" class="px-5 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full shadow hover:shadow-lg font-medium transition transform hover:-translate-y-1"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
         <button onclick="handleLogout()" class="px-4 py-2 bg-red-100 text-red-600 rounded-full hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å</button>
       </div>
      </div>
      <div class="flex gap-4 border-b border-gray-200 mb-6 overflow-x-auto">
          <button id="tabRestBtn" onclick="switchAdminTab('restaurants')" class="px-4 py-2 border-b-2 border-transparent hover:text-orange-500 font-medium whitespace-nowrap">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="tabReviewBtn" onclick="switchAdminTab('reviews')" class="px-4 py-2 border-b-2 border-transparent hover:text-orange-500 font-medium whitespace-nowrap">üí¨ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
          <button id="tabUserBtn" onclick="switchAdminTab('users')" class="px-4 py-2 border-b-2 border-transparent hover:text-orange-500 font-medium whitespace-nowrap">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      </div>
      <div id="adminTabRestaurants" class="admin-tab-content hidden"><div id="adminRestaurantList" class="space-y-4"></div></div>
      <div id="adminTabReviews" class="admin-tab-content hidden"><div id="adminReviewList" class="space-y-4"></div></div>
      <div id="adminTabUsers" class="admin-tab-content hidden"><div id="adminUserList" class="space-y-4"></div></div>
     </div>
    </div>

    <div id="restaurantModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-6">
       <div class="flex justify-between items-center mb-6 border-b pb-4"><h3 id="restaurantFormTitle" class="text-xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3><button onclick="closeRestaurantForm()" class="text-3xl text-gray-400 hover:text-gray-600">√ó</button></div>
       <div class="space-y-4">
        <div><label class="text-sm font-bold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô *</label><input type="text" id="formName" class="w-full px-4 py-2 border rounded-xl outline-none"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="text-sm font-bold text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label><select id="formCategory" class="w-full px-4 py-2 border rounded-xl outline-none"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option><option value="‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß">üçú ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á">üç≥ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô">üç£ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</option><option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô">üå∂Ô∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</option><option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option><option value="‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‚òï ‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option><option value="‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå">üçñ ‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå</option></select></div>
          <div><label class="text-sm font-bold text-gray-700">‡πÄ‡∏Ç‡∏ï *</label><select id="formZone" class="w-full px-4 py-2 border rounded-xl outline-none"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option></select></div>
        </div>
        <div class="bg-blue-50 p-3 rounded-xl border border-blue-200"><label class="text-sm font-bold text-blue-800">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</label><div class="grid grid-cols-2 gap-4 mt-2"><input type="number" id="formLat" step="any" class="w-full px-3 py-1 border rounded" placeholder="Lat"><input type="number" id="formLng" step="any" class="w-full px-3 py-1 border rounded" placeholder="Lng"></div></div>
        <div><label class="text-sm font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="formDescription" rows="3" class="w-full px-4 py-2 border rounded-xl outline-none"></textarea></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-sm font-bold text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input type="text" id="formAddress" class="w-full px-4 py-2 border rounded-xl outline-none"></div><div><label class="text-sm font-bold text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="formPhone" class="w-full px-4 py-2 border rounded-xl outline-none"></div></div>
        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-xl border"><div><label class="text-xs text-gray-500">‡πÄ‡∏õ‡∏¥‡∏î</label><input type="time" id="formOpenTime" class="w-full border rounded px-2 py-1"></div><div><label class="text-xs text-gray-500">‡∏õ‡∏¥‡∏î</label><input type="time" id="formCloseTime" class="w-full border rounded px-2 py-1"></div></div>
        <div class="border-2 border-dashed border-orange-200 rounded-xl p-4 bg-orange-50 text-center"><label class="block font-bold mb-2 text-orange-800">üì∑ ‡∏£‡∏π‡∏õ‡∏õ‡∏Å (1 ‡∏£‡∏π‡∏õ)</label><div id="coverPreview" class="hidden mb-3 relative h-48 bg-gray-200 rounded-lg overflow-hidden group"><img id="coverPreviewImg" class="h-full w-full object-cover"><button onclick="removeCoverImage()" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full">√ó</button></div><button onclick="document.getElementById('coverImageInput').click()" class="bg-white border border-orange-300 text-orange-600 px-4 py-2 rounded-lg text-sm font-bold">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button><input type="file" id="coverImageInput" accept="image/*" onchange="handleCoverUpload(event)" class="hidden"></div>
        <div class="flex gap-4 pt-4 border-t"><button onclick="closeRestaurantForm()" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="saveRestaurant()" id="saveRestaurantBtn" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
       </div>
      </div>
     </div>
    </div>

    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
         <h3 class="text-xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
         <div class="space-y-4"><input type="text" id="formUsername" class="w-full px-4 py-2 border rounded-xl" placeholder="Username"><input type="text" id="formPassword" class="w-full px-4 py-2 border rounded-xl" placeholder="Password"><select id="formRole" class="w-full px-4 py-2 border rounded-xl"><option value="owner">üëë ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</option><option value="moderator">üõ†Ô∏è ‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</option><option value="inspector">üîç ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option></select></div>
         <div class="flex gap-3 mt-6"><button onclick="closeUserForm()" class="flex-1 py-2 bg-gray-200 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="saveUser()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>

    <div id="imageViewerModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[90] cursor-pointer" onclick="closeImageViewer()"><div class="relative w-full h-full flex items-center justify-center p-4"><img id="fullImage" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-transform duration-300 transform scale-95 opacity-0"><button onclick="closeImageViewer()" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-bold">√ó</button></div></div>
    <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[80] p-4"><div class="bg-white rounded-2xl w-full max-w-4xl p-6"><h3 class="text-lg font-bold mb-4">‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å</h3><div class="mb-4 h-[60vh] bg-gray-100 rounded-xl overflow-hidden"><img id="cropImage" style="max-width: 100%;"></div><div class="flex gap-4"><button onclick="closeCropModal()" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="confirmCrop()" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div>

   </div>
  </div>

  <script>
    // --- üîë FIREBASE CONFIG (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß!) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHX9l4CYgX0BCFliagOnBCK1oFbu7sp9s",
      authDomain: "rattawut-food.firebaseapp.com",
      projectId: "rattawut-food",
      storageBucket: "rattawut-food.firebasestorage.app",
      messagingSenderId: "928937247925",
      appId: "1:928937247925:web:5d58ca32296f841a126afc",
      measurementId: "G-R2SSTS917K",
      // üëá ‡πÉ‡∏ä‡πâ Link ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Global) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
      databaseURL: "https://rattawut-food-default-rtdb.firebaseio.com" 
    };

    // Error Catcher (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏û‡∏±‡∏á‡∏≠‡∏µ‡∏Å ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ)
    window.onerror = function(msg, url, line) {
        document.getElementById('loadingStatus').textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + msg;
        setTimeout(() => showApp(), 2000); // ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á‡∏Å‡πá‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏û‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
        return false;
    };

    // Initialize
    if (!firebase.apps.length) {
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error("Firebase Error", e); }
    }
    const db = firebase.database();

    // --- 1. CONFIG & DATA ---
    const districts = ["‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£", "‡∏î‡∏∏‡∏™‡∏¥‡∏ï", "‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å", "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å", "‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô", "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô", "‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢", "‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á", "‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á", "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤", "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå", "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó", "‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà", "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô", "‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô", "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô", "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°", "‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞", "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î", "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á", "‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°", "‡∏™‡∏≤‡∏ó‡∏£", "‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠", "‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£", "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°", "‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®", "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢", "‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á", "‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á", "‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ", "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà", "‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°", "‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß", "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á", "‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤", "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤", "‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏", "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô"];
    let dbData = { restaurants:[], reviews:[], users:[] };
    let isConnected = false;

    // --- 2. STARTUP LOGIC (FAILSAFE ADDED) ---
    function startRealtimeSync() {
        document.getElementById('loadingStatus').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
        
        // Timeout Failsafe: ‡∏ñ‡πâ‡∏≤ 3 ‡∏ß‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏û‡πÄ‡∏•‡∏¢ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß)
        setTimeout(() => {
            if (!isConnected) {
                console.warn("Connection timeout, forcing UI load");
                showApp();
            }
        }, 3000);

        db.ref('.info/connected').on('value', function(snap) {
            if (snap.val() === true) {
                isConnected = true;
                document.getElementById('loadingStatus').textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            }
        });

        db.ref('restaurants').on('value', (s) => { dbData.restaurants = s.val() ? Object.values(s.val()) : []; renderGrid(); if(currentUser) renderAdminRestaurants(); showApp(); });
        db.ref('reviews').on('value', (s) => { dbData.reviews = s.val() ? Object.values(s.val()) : []; if(currentUser) renderAdminReviews(); });
        db.ref('users').on('value', (s) => { 
            dbData.users = s.val() ? Object.values(s.val()) : [];
            if(dbData.users.length === 0) create('users', { username: 'admin', password: '1234', role: 'owner' });
            if(currentUser) renderAdminUsers(); 
        });
    }

    function showApp() {
        const loader = document.getElementById('loadingScreen');
        const main = document.getElementById('mainContent');
        if (loader.style.display === 'none') return;
        
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            main.classList.remove('hidden');
            setTimeout(() => { main.classList.remove('opacity-0'); main.classList.add('opacity-100'); }, 50);
            showPage('home');
        }, 500);
    }

    function create(col, item) { const newRef = db.ref(col).push(); item.__backendId = newRef.key; return newRef.set(item); }
    function update(col, item) { return db.ref(col + '/' + item.__backendId).set(item); }
    function remove(col, id) { return db.ref(col + '/' + id).remove(); }

    // --- 3. VARIABLES ---
    let currentUser = null, editingItem = null, editingUser = null;
    let categoryFilter = '', coverImg = '', galleryImgs = [], cropper = null;
    let currentReviewRating = 0;
    let userLocation = null;

    // --- 4. INIT ---
    function init() {
        const z = document.getElementById('zoneFilter'), fz = document.getElementById('formZone');
        districts.sort().forEach(d => { z.innerHTML += `<option value="${d}">${d}</option>`; fz.innerHTML += `<option value="${d}">${d}</option>`; });
        startRealtimeSync();
    }

    // --- 5. NAV ---
    function showPage(p) { document.querySelectorAll('.page').forEach(x => { x.classList.remove('page-enter-active'); x.classList.add('hidden', 'page-enter'); }); const target = document.getElementById(p + 'Page'); target.classList.remove('hidden'); void target.offsetWidth; target.classList.add('page-enter-active'); target.classList.remove('page-enter', 'opacity-0'); window.scrollTo(0,0); }
    function setCategory(c) { categoryFilter = c; document.querySelectorAll('.category-btn').forEach(b => b.classList.toggle('active', b.dataset.category === c)); filterRestaurants(); }

    // --- 6. GEOLOCATION ---
    function getLocation() {
        const status = document.getElementById('locationStatus');
        if (!navigator.geolocation) { status.textContent = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"; return; }
        status.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
        navigator.geolocation.getCurrentPosition((pos) => {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            status.textContent = "‚úÖ ‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß";
            filterRestaurants();
        }, () => { status.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ"; });
    }
    function calculateDistance(lat1, lon1, lat2, lon2) { if(!lat1 || !lon1 || !lat2 || !lon2) return null; const R = 6371; const dLat = (lat2-lat1) * Math.PI/180; const dLon = (lon2-lon1) * Math.PI/180; const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2); return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); }

    // --- 7. HOME & GRID ---
    function filterRestaurants() {
        const s = document.getElementById('searchInput').value.toLowerCase();
        const z = document.getElementById('zoneFilter').value;
        let list = dbData.restaurants.filter(r => (!s || r.name.toLowerCase().includes(s)) && (!categoryFilter || r.category === categoryFilter) && (!z || r.zone === z));
        if(userLocation) { list = list.map(r => ({ ...r, distance: calculateDistance(userLocation.lat, userLocation.lng, r.lat, r.lng) })).sort((a,b) => (a.distance===null?1:a.distance) - (b.distance===null?1:b.distance)); }
        renderGrid(list);
    }
    function renderGrid(list) {
        const g = document.getElementById('restaurantGrid'), e = document.getElementById('emptyState');
        if(list.length===0) { g.innerHTML=''; e.classList.remove('hidden'); return; }
        e.classList.add('hidden');
        g.innerHTML = list.map(r => {
            const stats = getRestaurantRating(r.__backendId);
            const distStr = r.distance ? `<span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs ml-2 font-bold"><i class="fa-solid fa-location-dot"></i> ${r.distance.toFixed(1)} km</span>` : '';
            return `<div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover cursor-pointer group border border-gray-100" onclick="viewDetail('${r.__backendId}')"><div class="h-56 bg-gray-200 relative overflow-hidden">${r.coverImage ? `<div class="w-full h-full bg-cover bg-center transition-transform duration-500 group-hover:scale-110" style="background-image:url('${r.coverImage}')"></div>` : `<div class="flex items-center justify-center h-full text-4xl bg-orange-100 text-orange-300">üçú</div>`}<div class="absolute top-3 left-3 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-orange-600 shadow-sm">${r.category}</div><div class="absolute top-3 right-3 bg-black/70 backdrop-blur-sm px-2 py-1 rounded-lg text-xs font-bold text-yellow-400 shadow-sm flex items-center gap-1"><i class="fa-solid fa-star"></i> ${stats.avg} (${stats.count})</div></div><div class="p-5"><h3 class="font-bold text-xl text-gray-800 mb-1 leading-tight">${r.name} ${distStr}</h3><div class="text-sm text-gray-500 mb-3 flex items-center gap-1"><span class="text-red-500">üìç</span> ${r.zone}</div><p class="text-gray-500 text-sm line-clamp-2 mb-4 h-10">${r.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</p></div></div>`;
        }).join('');
    }
    function getRestaurantRating(rId) { const revs = dbData.reviews.filter(r => r.restaurantId === rId); if(revs.length === 0) return { avg: 0, count: 0 }; return { avg: (revs.reduce((a, b) => a + b.rating, 0) / revs.length).toFixed(1), count: revs.length }; }

    // --- 8. DETAIL PAGE ---
    function viewDetail(id) {
        const r = dbData.restaurants.find(i => i.__backendId === id);
        if(!r) return;
        const stats = getRestaurantRating(id);
        const reviews = dbData.reviews.filter(rv => rv.restaurantId === id).sort((a,b) => new Date(b.date) - new Date(a.date));
        const galleryHtml = (r.gallery && r.gallery.length > 0) ? `<div class="mt-8"><h3 class="text-xl font-bold mb-4">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3">${r.gallery.map(img => `<div class="aspect-square rounded-xl overflow-hidden shadow-sm cursor-zoom-in group" onclick="openImageViewer('${img}')"><img src="${img}" class="w-full h-full object-cover transition duration-300 group-hover:scale-110"></div>`).join('')}</div></div>` : '';
        const reviewsHtml = `<div class="mt-8 pt-8 border-t"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-gray-800">üí¨ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß <span class="text-base font-normal text-gray-500">(${reviews.length})</span></h3><div class="text-yellow-500 text-xl font-bold"><i class="fa-solid fa-star"></i> ${stats.avg}/5</div></div><div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 mb-8"><h4 class="font-bold text-gray-800 mb-3">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</h4><div class="flex gap-2 mb-4 star-rating" id="reviewStarInput">${[1,2,3,4,5].map(i => `<i class="fa-solid fa-star text-2xl inactive" onclick="setReviewRating(${i})" data-val="${i}"></i>`).join('')}</div><input type="text" id="reviewAuthor" class="w-full mb-3 px-4 py-2 border rounded-xl" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"><textarea id="reviewText" rows="2" class="w-full mb-3 px-4 py-2 border rounded-xl" placeholder="‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á..."></textarea><button onclick="submitReview('${r.__backendId}')" class="bg-orange-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-orange-600 transition">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button></div><div class="space-y-4">${reviews.length === 0 ? '<p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>' : reviews.map(rv => `<div class="bg-gray-50 p-4 rounded-xl flex gap-4"><div class="w-10 h-10 rounded-full bg-orange-200 flex items-center justify-center text-orange-600 font-bold shrink-0">${rv.author.charAt(0).toUpperCase()}</div><div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-gray-800">${rv.author}</span><div class="text-yellow-400 text-xs">${'<i class="fa-solid fa-star"></i>'.repeat(rv.rating)}</div><span class="text-xs text-gray-400 ml-2">${new Date(rv.date).toLocaleDateString('th-TH')}</span></div><p class="text-gray-600 text-sm">${rv.text}</p></div></div>`).join('')}</div></div>`;
        document.getElementById('restaurantDetailContent').innerHTML = `<div class="h-[40vh] w-full bg-gray-200 relative group overflow-hidden cursor-zoom-in" onclick="openImageViewer('${r.coverImage || ''}')">${r.coverImage ? `<div class="w-full h-full bg-cover bg-center" style="background-image:url('${r.coverImage}')"></div>` : `<div class="flex items-center justify-center h-full text-8xl bg-orange-100 text-orange-300">üçú</div>`}<div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div><div class="absolute bottom-0 left-0 right-0 p-8 text-white"><span class="bg-orange-500 px-3 py-1 rounded-full text-sm font-bold mb-2 inline-block">${r.category}</span><h1 class="text-3xl font-bold mb-2">${r.name}</h1><p class="opacity-90">üìç ‡πÄ‡∏Ç‡∏ï${r.zone} | üïí ${r.openTime} - ${r.closeTime}</p></div></div><div class="p-8"><div class="grid md:grid-cols-3 gap-8"><div class="md:col-span-2"><h3 class="font-bold text-gray-800 mb-3 text-2xl">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3><p class="text-gray-600 leading-relaxed text-lg">${r.description || '-'}</p>${galleryHtml}${reviewsHtml}</div><div class="md:col-span-1"><div class="bg-white p-6 rounded-2xl border shadow-sm sticky top-24"><h4 class="font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h4><ul class="space-y-3 text-gray-600"><li>üè† ${r.address || '-'}</li><li>üìû ${r.phone || '-'}</li></ul><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${r.lat||''},${r.lng||''}')" class="w-full mt-4 py-2 bg-blue-500 text-white rounded-lg font-bold">üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button></div></div></div></div>`;
        showPage('detail');
        setReviewRating(0);
    }
    function setReviewRating(val) { currentReviewRating = val; document.querySelectorAll('#reviewStarInput i').forEach(star => { const v=parseInt(star.dataset.val); star.className=`fa-solid fa-star text-2xl ${v<=val?'active':'inactive'}`; }); }
    async function submitReview(rId) { if(currentReviewRating===0)return alert('‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö'); const t=document.getElementById('reviewText').value.trim(), a=document.getElementById('reviewAuthor').value.trim()||'‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°'; await create('reviews', {restaurantId:rId, rating:currentReviewRating, text:t, author:a, date:new Date().toISOString()}); alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö!'); viewDetail(rId); }

    // --- 9. ADMIN ---
    function handleLogin() { const u=document.getElementById('loginUsername').value, p=document.getElementById('loginPassword').value; const user=dbData.users.find(x => x.username===u && x.password===p); if(user){ currentUser=user; document.getElementById('adminNameDisplay').textContent=u; document.getElementById('adminRoleBadge').textContent=user.role; renderAdminTabs(); showPage('admin'); } else alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à)'); }
    function renderAdminTabs() { const r=currentUser.role; document.getElementById('tabRestBtn').style.display=(r==='owner'||r==='moderator')?'block':'none'; document.getElementById('tabUserBtn').style.display=(r==='owner')?'block':'none'; (r==='owner'||r==='moderator')?switchAdminTab('restaurants'):switchAdminTab('reviews'); }
    function switchAdminTab(t) { document.querySelectorAll('.admin-tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden'); if(t==='restaurants')renderAdminRestaurants(); if(t==='reviews')renderAdminReviews(); if(t==='users')renderAdminUsers(); }
    
    function renderAdminRestaurants() { document.getElementById('adminRestaurantList').innerHTML=dbData.restaurants.map(r=>`<div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border gap-4"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded bg-gray-200 overflow-hidden shrink-0">${r.coverImage?`<img src="${r.coverImage}" class="w-full h-full object-cover">`:''}</div><div class="font-bold">${r.name}</div></div><div class="flex gap-2"><button onclick='showRestaurantForm(${JSON.stringify(r).replace(/'/g, "\\'")})' class="px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button onclick="deleteItem('restaurants','${r.__backendId}')" class="px-3 py-1 bg-red-50 text-red-600 rounded-lg text-sm font-bold">‡∏•‡∏ö</button></div></div>`).join(''); }
    function renderAdminReviews() { document.getElementById('adminReviewList').innerHTML=dbData.reviews.map(rv=>`<div class="p-4 bg-white rounded-xl shadow-sm border"><div class="flex justify-between mb-2"><div class="font-bold text-gray-800">${dbData.restaurants.find(r=>r.__backendId===rv.restaurantId)?.name||'Unknown'}</div><div class="text-yellow-500 text-sm"><i class="fa-solid fa-star"></i> ${rv.rating}</div></div><p class="text-gray-600 text-sm mb-2">"${rv.text}" - <b>${rv.author}</b></p><div class="flex justify-end"><button onclick="deleteItem('reviews','${rv.__backendId}')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button></div></div>`).join(''); }
    function renderAdminUsers() { document.getElementById('adminUserList').innerHTML=dbData.users.map(u=>`<div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border"><div><div class="font-bold">${u.username}</div><div class="text-xs text-gray-500 uppercase">${u.role}</div></div>${u.username!=='admin'?`<div class="flex gap-2"><button onclick="deleteItem('users','${u.__backendId}')" class="px-3 py-1 bg-red-50 text-red-600 rounded text-xs font-bold">‡∏•‡∏ö</button></div>`:''}</div>`).join(''); }

    // --- 10. FORM & UTILS ---
    function showRestaurantForm(r=null) { editingItem=r; document.getElementById('restaurantFormTitle').textContent=r?'‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç':'‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô'; ['Name','Category','Zone','Description','Address','Phone','OpenTime','CloseTime','Lat','Lng'].forEach(k => document.getElementById('form'+k).value = r?(r[k.toLowerCase().replace('name','name').replace('time','Time')]||''):''); coverImg=r?.coverImage||''; galleryImgs=r?.gallery?[...r.gallery]:[]; updatePreviews(); document.getElementById('restaurantModal').classList.remove('hidden'); document.getElementById('restaurantModal').classList.add('flex'); }
    function showUserForm() { document.getElementById('userModal').classList.remove('hidden'); document.getElementById('userModal').classList.add('flex'); }
    async function saveRestaurant() { const name=document.getElementById('formName').value; if(!name)return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô'); const data={name,category:document.getElementById('formCategory').value,zone:document.getElementById('formZone').value,description:document.getElementById('formDescription').value,address:document.getElementById('formAddress').value,phone:document.getElementById('formPhone').value,openTime:document.getElementById('formOpenTime').value,closeTime:document.getElementById('formCloseTime').value,lat:parseFloat(document.getElementById('formLat').value),lng:parseFloat(document.getElementById('formLng').value),coverImage:coverImg,gallery:galleryImgs}; editingItem?await update('restaurants',{...editingItem,...data}):await create('restaurants',data); closeRestaurantForm(); }
    async function saveUser() { const u=document.getElementById('formUsername').value, p=document.getElementById('formPassword').value, r=document.getElementById('formRole').value; if(!u||!p)return; await create('users',{username:u,password:p,role:r}); closeUserForm(); }
    async function deleteItem(col,id) { if(confirm('‡∏•‡∏ö‡∏ô‡∏∞?')) await remove(col,id); }

    function closeRestaurantForm() { document.getElementById('restaurantModal').classList.add('hidden'); document.getElementById('restaurantModal').classList.remove('flex'); }
    function closeUserForm() { document.getElementById('userModal').classList.add('hidden'); document.getElementById('userModal').classList.remove('flex'); }
    function handleLogout() { currentUser=null; showPage('home'); }
    function resizeImage(file, maxWidth = 500) { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ratio = maxWidth / img.width; canvas.width = maxWidth; canvas.height = img.height * ratio; canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.6)); }; }; }); }
    function handleCoverUpload(e) { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>{ document.getElementById('cropImage').src=ev.target.result; document.getElementById('cropModal').classList.remove('hidden'); document.getElementById('cropModal').classList.add('flex'); if(cropper)cropper.destroy(); cropper=new Cropper(document.getElementById('cropImage'),{aspectRatio:16/9,viewMode:1}); }; r.readAsDataURL(f); } e.target.value=''; }
    function confirmCrop() { if(!cropper)return; const c=cropper.getCroppedCanvas({maxWidth:600}); coverImg=c.toDataURL('image/jpeg',0.7); updatePreviews(); document.getElementById('cropModal').classList.add('hidden'); document.getElementById('cropModal').classList.remove('flex'); }
    function closeCropModal() { document.getElementById('cropModal').classList.add('hidden'); document.getElementById('cropModal').classList.remove('flex'); }
    async function handleGalleryUpload(e) { const fs=Array.from(e.target.files); for(let f of fs) galleryImgs.push(await resizeImage(f,450)); updatePreviews(); e.target.value=''; }
    function removeCoverImage() { coverImg=''; updatePreviews(); }
    function removeGalleryImage(i) { galleryImgs.splice(i,1); updatePreviews(); }
    function updatePreviews() { const cp=document.getElementById('coverPreview'), cpi=document.getElementById('coverPreviewImg'); coverImg?(cp.classList.remove('hidden'),cpi.src=coverImg):cp.classList.add('hidden'); document.getElementById('galleryPreviewGrid').innerHTML=galleryImgs.map((img,i)=>`<div class="relative aspect-square bg-gray-100 rounded overflow-hidden group border"><img src="${img}" class="w-full h-full object-cover"><button onclick="removeGalleryImage(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">√ó</button></div>`).join(''); }
    function openImageViewer(src) { if(!src)return; document.getElementById('fullImage').src=src; document.getElementById('imageViewerModal').classList.remove('hidden'); setTimeout(()=>{document.getElementById('fullImage').classList.replace('scale-95','scale-100'); document.getElementById('fullImage').classList.replace('opacity-0','opacity-100');},10); }
    function closeImageViewer() { const i=document.getElementById('fullImage'); i.classList.replace('scale-100','scale-95'); i.classList.replace('opacity-100','opacity-0'); setTimeout(()=>{document.getElementById('imageViewerModal').classList.add('hidden'); i.src='';},300); }

    init();
  </script>
 </body>
</html>
